-- start query 8 in stream 0 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '10000','10001','10002','10003','10004','10005',
                          '10006','10007','10008','10009','10010',
                          '10011','10012','10013','10014','10015',
                          '10016','10017','10018','10019','10020',
                          '10021','10022','10023','10024','10025',
                          '10026','10027','10028','10029','10030',
                          '10031','10032','10033','10034','10035',
                          '10036','10037','10038','10039','10040',
                          '10041','10042','10043','10044','10045',
                          '10046','10047','10048','10049','10050',
                          '10051','10052','10053','10054','10055',
                          '10056','10057','10058','10059','10060',
                          '10061','10062','10063','10064','10065',
                          '10066','10067','10068','10069','10070',
                          '10071','10072','10073','10074','10075',
                          '10076','10077','10078','10079','10080',
                          '10081','10082','10083','10084','10085',
                          '10086','10087','10088','10089','10090',
                          '10091','10092','10093','10094','10095',
                          '10096','10097','10098','10099','10100',
                          '10101','10102','10103','10104','10105',
                          '10106','10107','10108','10109','10110',
                          '10111','10112','10113','10114','10115',
                          '10116','10117','10118','10119','10120',
                          '10121','10122','10123','10124','10125',
                          '10126','10127','10128','10129','10130',
                          '10131','10132','10133','10134','10135',
                          '10136','10137','10138','10139','10140',
                          '10141','10142','10143','10144','10145',
                          '10146','10147','10148','10149','10150',
                          '10151','10152','10153','10154','10155',
                          '10156','10157','10158','10159','10160',
                          '10161','10162','10163','10164','10165',
                          '10166','10167','10168','10169','10170',
                          '10171','10172','10173','10174','10175',
                          '10176','10177','10178','10179','10180',
                          '10181','10182','10183','10184','10185',
                          '10186','10187','10188','10189','10190',
                          '10191','10192','10193','10194','10195',
                          '10196','10197','10198','10199','10200',
                          '10201','10202','10203','10204','10205',
                          '10206','10207','10208','10209','10210',
                          '10211','10212','10213','10214','10215',
                          '10216','10217','10218','10219','10220',
                          '10221','10222','10223','10224','10225',
                          '10226','10227','10228','10229','10230',
                          '10231','10232','10233','10234','10235',
                          '10236','10237','10238','10239','10240',
                          '10241','10242','10243','10244','10245',
                          '10246','10247','10248','10249','10250',
                          '10251','10252','10253','10254','10255',
                          '10256','10257','10258','10259','10260',
                          '10261','10262','10263','10264','10265',
                          '10266','10267','10268','10269','10270',
                          '10271','10272','10273','10274','10275',
                          '10276','10277','10278','10279','10280',
                          '10281','10282','10283','10284','10285',
                          '10286','10287','10288','10289','10290',
                          '10291','10292','10293','10294','10295',
                          '10296','10297','10298','10299','10300',
                          '10301','10302','10303','10304','10305',
                          '10306','10307','10308','10309','10310',
                          '10311','10312','10313','10314','10315',
                          '10316','10317','10318','10319','10320',
                          '10321','10322','10323','10324','10325',
                          '10326','10327','10328','10329','10330',
                          '10331','10332','10333','10334','10335',
                          '10336','10337','10338','10339','10340',
                          '10341','10342','10343','10344','10345',
                          '10346','10347','10348','10349','10350',
                          '10351','10352','10353','10354','10355',
                          '10356','10357','10358','10359','10360',
                          '10361','10362','10363','10364','10365',
                          '10366','10367','10368','10369','10370',
                          '10371','10372','10373','10374','10375',
                          '10376','10377','10378','10379','10380',
                          '10381','10382','10383','10384','10385',
                          '10386','10387','10388','10389','10390',
                          '10391','10392','10393','10394','10395',
                          '10396','10397','10398','10399')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100

-- end query 8 in stream 0 using template query8.tpl
